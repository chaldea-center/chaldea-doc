# Laplace 开发笔记

又名《螺旋社之十万个为什么》

::: details 目录
[[toc]]
:::

## 大总统指令卡的目标切换

宝具卡、全体攻击卡(大总统 Buster / Extra)前后均会触发敌方的退场/亡语/目标切换。
举例说明：大总统BAQ接EX会执行三次退场结算:

1. Buster后执行第一次退场
2. AQ之后执行第二次退场
3. EX之后执行第三次退场

## DOT伤害结算

回合结束时，先记录当前血量(`hp`)为`currentHp`，接着先结算回血，再结算扣血。若扣血会导致从者退场(`hp <= 0`):

- 当敌方(包括候补)存在幸存者: 正常结算，即`damage = hp - DotDamage`
- 当敌方(包括候补)全部死亡时: 让该从者存活，DoT伤害变为`currentHp - 1`

举例说明，巴贝奇装备1HP的毅力礼装后使用3技能(300 DoT)，梵高使用二技能(100 Dot + 300 HoT)，接着陈宫嘲讽自己发射巴贝奇：

- 若当前敌方(包括候补)存在幸存者: 巴贝奇血量为 `1 + 300 - 400 < 0` 结算阵亡退场
- 若当敌方(包括候补)全部死亡时: 巴贝奇血量为 `1 + 300 - 0 = 301`，此时由于当前血量为1，所以DoT伤害为 `1 - 1 = 0`

也就是说，击杀当前wave的全部敌人可以帮助有致死DoT的从者多活一回合。

## 鞭尸 Bug Bug

众所周知，fgo的普通指令卡有鞭尸bug，导致即使游戏内未显示Overkill时也算作Overkill。

该bug作为良性bug被当作feature保留了下来，如果出卡之间敌方结算了退场并且发动亡语或者毅力时发动的buff，则鞭尸bug失效。

该鞭尸bug bug可以在2.6的新达灵顿free第二面测试，这面包含一个没有亡语的大怪和两个有亡语的小怪。使用AOE宝具击杀两个小怪同时把大怪打到半血以下可以发现鞭尸bug此时失效。

## 复数改变职阶相性的叠加

举例莱妮斯放宝具打消防御不利相性，迦摩使用三技能变为对AE阶有利，同时AE阶敌方单位赋予自身对杀阶攻击有利，最终该AE阶敌方攻击迦摩会是几倍克制？

该问题的答案取决于迦摩三技能和莱妮斯宝具的顺序:

- 首先，防御方的buff会覆盖掉攻击方的，所以直接忽视AE攻击者的buff
- 迦摩身上此时有复数的职阶相性buff，**先上的buff覆盖后上的buff**，即先放莱妮斯宝具，则最终克制系数为1; 反之先放迦摩三技能，则为0.5

~~很神奇吧~~

## 复数宝具色卡变更buff的叠加

可以自己带俩光兔兔和仇凛 + CD服试试看！答案是后选的卡色会覆盖先选的卡色。

## 复仇/Revenge的目标选择

复仇相关Buff: selfturnendFunction(每回合结束发动), delayFunction(X回合后发动), gutsFunction(毅力时发动),
damageFunction(受击时发动), deadFunction(死亡时发动)。每个trigger skill单独计算复仇目标。

自身受到伤害类型分为: 指令卡伤害、宝具伤害、HP减少(lossHp)、DoT(毒/诅咒/灼烧, 无攻击来源)、damageValue(多见于敌方直接造成伤害)。

::: warning
目前目标选择机制仍存疑
:::

1. 复仇目标选择

    以上buff触发技能时，将最后一个攻击自身的人设定为复仇目标（无论敌方/己方、前排/后排、是否死亡）:

    - 排除攻击来源于自身或无来源
    - 若`DataVals.OpponentOnly`，则仅遍历敌方（目前仅deadFunction使用）

    若复仇目标不存在，则随机选择一名“敌方单体”。在Laplace中应回退至选中的敌方单位。

2. 根据`func.funcTargetType`选择实际发动目标

   - `enemy`: 敌方单体，若上述存在复仇目标，则使用该目标（无论是敌方还是己方）。若目标已死亡，则由于无目标不发动。
   - `enemyOneNoDamageNoAction`: 同上，但仅在自身受到伤害时发动。
   - `enemyOther`/`enemyOtherFull`: 除目标外的敌方全体，首先获取敌方全体，再剔除上述复仇目标，因此:
     - 若复仇目标为己方，实际为敌方全体
     - 若复仇目标为敌方，实际为复仇目标外的敌方全体

## 小安宝具机制

目前测试结果为，小安会在我方回合结束时记录自身当前血量，当反弹伤害时，造成的基础伤害（宝具倍率增幅前）为 `记录的血量 - 当前剩余HP`。

举例：我方回合结束时小安血量为 4000，敌方回合结束时小安血量为 5000，则基础伤害为 `4000 - 5000 = -1000`，由于不能造成负数伤害所以调整为0。
该情景可以用陈宫宝具 + 给小安两次毅力模拟（先金色庆典的毅力，再上小安自己的毅力）。
若毅力施加顺序相反，则我方回合结束时小安血量为 4490，敌方回合结束时小安血量为 4000，则基础伤害为 `4490 - 4000 = 490`。
